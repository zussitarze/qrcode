#lang racket/base

(module+ test
  (require rackunit))

(require
  racket/contract
  racket/list
  racket/match)

(define error-level/c (one-of/c 'L 'M 'Q 'H))
(define version/c (integer-in 1 40))
(define kind/c (one-of/c 'byte))

(provide
 (struct-out spec)
 (contract-out 
  [lookup-spec (-> version/c error-level/c spec?)]
  [bestfit (-> bytes? error-level/c kind/c (or/c version/c #f))]
  [canhold? (-> bytes? version/c error-level/c kind/c boolean?)]
  [version->dimension (-> version/c number?)]
  [alignment-coords (-> version/c list?)]
  [character-count-bits (-> version/c number?)]))

(struct spec (msg-codes ec-codes ec1 ec2 mxnum mxalpha mxbyte mxjanji))

(define (lookup-spec ver err)
  (apply spec (cdr (assq err (vector-ref spec-tbl (- ver 1))))))

(define (version->dimension v)
  (+ 17 (* 4 v)))

(define (bestfit msg err kind)
  (let ([sel (case kind [(byte) spec-mxbyte])]
        [len (bytes-length msg)]) 
    (for/or ([v (in-range 1 41)])
      (and (>= (sel (lookup-spec v err)) len)
           v))))

(module+ test
  (check-eqv? (bestfit #"123" 'L 'byte) 1)
  (check-eqv? (bestfit (make-bytes 1024) 'Q 'byte) 31)
  (check-eqv? (bestfit (make-bytes 2954) 'L 'byte) #f))

(define (canhold? msg ver err kind)
  (let ([sel (case kind [(byte) spec-mxbyte])]
        [len (bytes-length msg)])
    (>= (sel (lookup-spec ver err)) len)))

(define (alignment-coords v)
  (if (= v 1)
      '()
      (let* ([rcs (vector-ref alignment-tbl (- v 1))]
             [f (car rcs)]
             [l (last rcs)])
        (for*/list ([i (in-list rcs)]
                    [j (in-list rcs)]
                    #:unless (or (and (= i f) (= j f))
                                 (and (= i f) (= j l))
                                 (and (= j f) (= i l))))
          (cons (- j 2) (- i 2))))))

(define spec-tbl
  ;;       msg-codes    ec-codes        ec1     ec2     num     alph    bytes   kanji  
  #(((L . (19		7               1	0  	41      25      17      10))
     (M . (16   	10		1	0  	34      20      14      8))
     (Q . (13   	13		1	0  	27      16      11      7))
     (H . (9    	17		1	0  	17      10      7       4)))
    ((L . (34   	10		1	0  	77      47      32      20))
     (M . (28   	16		1	0  	63      38      26      16))
     (Q . (22   	22		1	0  	48      29      20      12))
     (H . (16   	28		1	0  	34      20      14      8)))
    ((L . (55   	15		1	0  	127     77      53      32))
     (M . (44   	26		1	0  	101     61      42      26))
     (Q . (34   	36		2	0  	77      47      32      20))
     (H . (26   	44		2	0  	58      35      24      15)))
    ((L . (80   	20		1	0  	187     114     78      48))
     (M . (64   	36		2	0  	149     90      62      38))
     (Q . (48   	52		2	0  	111     67      46      28))
     (H . (36   	64		4	0  	82      50      34      21)))
    ((L . (108   	26		1	0  	255     154     106     65))
     (M . (86   	48		2	0  	202     122     84      52))
     (Q . (62   	72		2	2  	144     87      60      37))
     (H . (46   	88		2	2  	106     64      44      27)))
    ((L . (136  	36		2	0  	322     195     134     82))
     (M . (108   	64		4	0  	255     154     106     65))
     (Q . (76   	96		4	0  	178     108     74      45))
     (H . (60   	112		4	0  	139     84      58      36)))
    ((L . (156  	40		2	0  	370     224     154     95))
     (M . (124   	72		4	0  	293     178     122     75))
     (Q . (88   	108		2	4  	207     125     86      53))
     (H . (66   	130		4	1  	154     93      64      39)))
    ((L . (194  	48		2	0  	461     279     192     118))
     (M . (154  	88		2	2  	365     221     152     93))
     (Q . (110   	132		4	2  	259     157     108     66))
     (H . (86   	156		4	2  	202     122     84      52)))
    ((L . (232  	60		2	0  	552     335     230     141))
     (M . (182  	110		3	2  	432     262     180     111))
     (Q . (132  	160		4	4  	312     189     130     80))
     (H . (100   	192		4	4  	235     143     98      60)))
    ((L . (274  	72		2	2  	652     395     271     167))
     (M . (216  	130		4	1  	513     311     213     131))
     (Q . (154  	192		6	2  	364     221     151     93))
     (H . (122   	224		6	2  	288     174     119     74)))
    ((L . (324  	80		4	0  	772     468     321     198))
     (M . (254  	150		1	4  	604     366     251     155))
     (Q . (180  	224		4	4  	427     259     177     109))
     (H . (140  	264		3	8  	331     200     137     85)))
    ((L . (370  	96		2	2  	883     535     367     226))
     (M . (290  	176		6	2  	691     419     287     177))
     (Q . (206  	260		4	6  	489     296     203     125))
     (H . (158  	308		7	4  	374     227     155     96)))
    ((L . (428  	104		4	0  	1022    619     425     262))
     (M . (334  	198		8	1  	796     483     331     204))
     (Q . (244  	288		8	4  	580     352     241     149))
     (H . (180  	352		12	4  	427     259     177     109)))
    ((L . (461  	120		3	1  	1101    667     458     282))
     (M . (365  	216		4	5  	871     528     362     223))
     (Q . (261  	320		11	5  	621     376     258     159))
     (H . (197  	384		11	5  	468     283     194     120)))
    ((L . (523  	132		5	1  	1250    758     520     320))
     (M . (415  	240		5	5  	991     600     412     254))
     (Q . (295  	360		5	7  	703     426     292     180))
     (H . (223  	432		11	7  	530     321     220     136)))
    ((L . (589  	144		5	1  	1408    854     586     361))
     (M . (453  	280		7	3  	1082    656     450     277))
     (Q . (325  	408		15	2  	775     470     322     198))
     (H . (253  	480		3	13 	602     365     250     154)))
    ((L . (647  	168		1	5  	1548    938     644     397))
     (M . (507  	308		10	1  	1212    734     504     310))
     (Q . (367  	448		1	15 	876     531     364     224))
     (H . (283  	532		2	17 	674     408     280     173)))
    ((L . (721  	180		5	1  	1725    1046    718     442))
     (M . (563  	338		9	4  	1346    816     560     345))
     (Q . (397  	504		17	1  	948     574     394     243))
     (H . (313  	588		2	19 	746     452     310     191)))
    ((L . (795  	196		3	4  	1903    1153    792     488))
     (M . (627  	364		3	11 	1500    909     624     384))
     (Q . (445  	546		17	4  	1063    644     442     272))
     (H . (341  	650		9	16 	813     493     338     208)))
    ((L . (861  	224		3	5  	2061    1249    858     528))
     (M . (669  	416		3	13 	1600    970     666     410))
     (Q . (485  	600		15	5  	1159    702     482     297))
     (H . (385  	700		15	10 	919     557     382     235)))
    ((L . (932  	224		4	4  	2232    1352    929     572))
     (M . (714  	442		17	0  	1708    1035    711     438))
     (Q . (512  	644		17	6  	1224    742     509     314))
     (H . (406  	750		19	6  	969     587     403     248)))
    ((L . (1006  	252		2	7  	2409    1460    1003    618))
     (M . (782  	476		17	0  	1872    1134    779     480))
     (Q . (568  	690		7	16 	1358    823     565     348))
     (H . (442  	816		34	0  	1056    640     439     270)))
    ((L . (1094  	270		4	5  	2620    1588    1091    672))
     (M . (860  	504		4	14 	2059    1248    857     528))
     (Q . (614  	750		11	14 	1468    890     611     376))
     (H . (464  	900		16	14 	1108    672     461     284)))
    ((L . (1174  	300		6	4  	2812    1704    1171    721))
     (M . (914  	560		6	14 	2188    1326    911     561))
     (Q . (664  	810		11	16 	1588    963     661     407))
     (H . (514  	960		30	2  	1228    744     511     315)))
    ((L . (1276 	312		8	4  	3057    1853    1273    784))
     (M . (1000  	588		8	13 	2395    1451    997     614))
     (Q . (718  	870		7	22 	1718    1041    715     440))
     (H . (538  	1050		22	13 	1286    779     535     330)))
    ((L . (1370 	336		10	2  	3283    1990    1367    842))
     (M . (1062  	644		19	4  	2544    1542    1059    652))
     (Q . (754  	952		28	6  	1804    1094    751     462))
     (H . (596  	1110		33	4  	1425    864     593     365)))
    ((L . (1468 	360		8	4  	3517    2132    1465    902))
     (M . (1128  	700		22	3  	2701    1637    1125    692))
     (Q . (808  	1020		8	26 	1933    1172    805     496))
     (H . (628  	1200		12	28 	1501    910     625     385)))
    ((L . (1531 	390		3	10 	3669    2223    1528    940))
     (M . (1193  	728		3	23 	2857    1732    1190    732))
     (Q . (871  	1050		4	31 	2085    1263    868     534))
     (H . (661  	1260		11	31 	1581    958     658     405)))
    ((L . (1631 	420		7	7  	3909    2369    1628    1002))
     (M . (1267 	784		21	7  	3035    1839    1264    778))
     (Q . (911  	1140		1	37 	2181    1322    908     559))
     (H . (701  	1350		19	26 	1677    1016    698     430)))
    ((L . (1735 	450		5	10 	4158    2520    1732    1066))
     (M . (1373 	812		19	10 	3289    1994    1370    843))
     (Q . (985  	1200		15	25 	2358    1429    982     604))
     (H . (745  	1440		23	25 	1782    1080    742     457)))
    ((L . (1843 	480		13	3  	4417    2677    1840    1132))
     (M . (1455 	868		2	29 	3486    2113    1452    894))
     (Q . (1033  	1290		42	1  	2473    1499    1030    634))
     (H . (793  	1530		23	28 	1897    1150    790     486)))
    ((L . (1955 	510		17	0  	4686    2840    1952    1201))
     (M . (1541 	924		10	23 	3693    2238    1538    947))
     (Q . (1115  	1350		10	35 	2670    1618    1112    684))
     (H . (845  	1620		19	35 	2022    1226    842     518)))
    ((L . (2071 	540		17	1  	4965    3009    2068    1273))
     (M . (1631 	980		14	21 	3909    2369    1628    1002))
     (Q . (1171  	1440		29	19 	2805    1700    1168    719))
     (H . (901  	1710		11	46 	2157    1307    898     553)))
    ((L . (2191 	570		13	6  	5253    3183    2188    1347))
     (M . (1725 	1036		14	23 	4134    2506    1722    1060))
     (Q . (1231  	1530		44	7  	2949    1787    1228    756))
     (H . (961  	1800		59	1  	2301    1394    958     590)))
    ((L . (2306 	570		12	7  	5529    3351    2303    1417))
     (M . (1812 	1064		12	26 	4343    2632    1809    1113))
     (Q . (1286 	1590		39	14 	3081    1867    1283    790))
     (H . (986  	1890		22	41 	2361    1431    983     605)))
    ((L . (2434 	600		6	14 	5836    3537    2431    1496))
     (M . (1914 	1120		6	34 	4588    2780    1911    1176))
     (Q . (1354 	1680		46	10 	3244    1966    1351    832))
     (H . (1054  	1980		2	64 	2524    1530    1051    647)))
    ((L . (2566 	630		17	4  	6153    3729    2563    1577))
     (M . (1992 	1204		29	14 	4775    2894    1989    1224))
     (Q . (1426 	1770		49	10 	3417    2071    1423    876))
     (H . (1096  	2100		24	46 	2625    1591    1093    673)))
    ((L . (2702 	660		4	18 	6479    3927    2699    1661))
     (M . (2102 	1260		13	32 	5039    3054    2099    1292))
     (Q . (1502 	1860		48	14 	3599    2181    1499    923))
     (H . (1142  	2220		42	32 	2735    1658    1139    701)))
    ((L . (2812 	720		20	4  	6743    4087    2809    1729))
     (M . (2216 	1316		40	7  	5313    3220    2213    1362))
     (Q . (1582 	1950		43	22 	3791    2298    1579    972))
     (H . (1222  	2310		10	67 	2927    1774    1219    750)))
    ((L . (2956 	750		19	6  	7089    4296    2953    1817))
     (M . (2334 	1372		18	31 	5596    3391    2331    1435))
     (Q . (1666 	2040		34	34 	3993    2420    1663    1024))
     (H . (1276 	2430		20	61 	3057    1852    1273    784)))))


(define alignment-tbl
  #(()
    (6  18)      
    (6  22)
    (6  26)
    (6  30)
    (6  34)
    (6  22  38)
    (6  24  42)
    (6  26  46)
    (6  28  50)
    (6  30  54)
    (6  32  58)
    (6  34  62)
    (6  26  46  66)
    (6  26  48  70)
    (6  26  50  74)
    (6  30  54  78)
    (6  30  56  82)
    (6  30  58  86)
    (6  34  62  90)
    (6  28  50  72  94)
    (6  26  50  74  98)
    (6  30  54  78  102)
    (6  28  54  80  106)
    (6  32  58  84  110)
    (6  30  58  86  114)
    (6  34  62  90  118)
    (6  26  50  74  98  122)
    (6  30  54  78  102  126)
    (6  26  52  78  104  130)
    (6  30  56  82  108  134)
    (6  34  60  86  112  138)
    (6  30  58  86  114  142)
    (6  34  62  90  118  146)
    (6  30  54  78  102  126  150)
    (6  24  50  76  102  128  154)
    (6  28  54  80  106  132  158)
    (6  32  58  84  110  136  162)
    (6  26  54  82  110  138  166)
    (6  30  58  86  114  142  170)))


(define (character-count-bits ver)
  ;; todo: This shouldn't be hardcoded to bytes.
  (match (cond [(<= ver 9)  '(10 9 8 8)]
               [(<= ver 26) '(12 11 16 10)]
               [(<= ver 40) '(14 13 16 12)])
    [(list num alph byte kanji) byte]))
